<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documental Intelligence | Cloud Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0b1120; color: #f1f5f9; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .transition-all { transition: all 0.3s ease; }
    </style>
</head>
<body class="antialiased h-screen overflow-hidden flex text-slate-200">

    <div id="modalHO" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass w-full max-w-lg rounded-[2.5rem] p-8 border border-blue-500/30 shadow-2xl shadow-blue-500/10">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-blue-400">Eleg√≠veis Home Office</h3>
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">Crit√©rio: +90% Qualidade & Top 20 Produ√ß√£o</p>
                </div>
                <button onclick="closeHO()" class="bg-slate-800 hover:bg-slate-700 w-10 h-10 rounded-full flex items-center justify-center transition-all text-white text-xl">&times;</button>
            </div>
            <div id="listHO" class="space-y-3 max-h-[60vh] overflow-y-auto sidebar-scroll pr-2"></div>
        </div>
    </div>

    <aside class="w-80 border-r border-slate-800 flex flex-col bg-[#0b1120] shrink-0">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center font-bold text-xl shadow-lg shadow-blue-500/20 text-white">D</div>
                <div>
                    <h1 class="font-bold text-lg leading-tight text-white italic tracking-tighter">An√°lise Documental</h1>
                    <p class="text-[10px] text-slate-500 uppercase tracking-[2px]">Gest√£o: Vitor Martins</p>
                </div>
            </div>

            <label class="flex items-center justify-center gap-2 w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl cursor-pointer transition-all mb-6 text-white font-bold text-sm shadow-lg shadow-blue-600/20 active:scale-95">
                <span>üìÇ IMPORTAR PLANILHA</span>
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv">
            </label>

            <div class="flex gap-2 mb-4 bg-slate-900/80 p-1.5 rounded-xl border border-slate-800">
                <button onclick="changeSort('prod')" id="btnSortProd" class="flex-1 text-[9px] py-2 rounded-lg font-bold transition-all bg-slate-700 text-white uppercase shadow-sm">Produ√ß√£o</button>
                <button onclick="changeSort('quali')" id="btnSortQuali" class="flex-1 text-[9px] py-2 rounded-lg font-bold transition-all text-slate-500 uppercase hover:text-white">Qualidade</button>
            </div>
        </div>

        <div id="analystList" class="flex-1 overflow-y-auto sidebar-scroll px-4 pb-6 space-y-2">
            <div class="flex flex-col items-center justify-center mt-20 text-slate-600">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mb-4"></div>
                <p class="text-[10px] font-bold uppercase tracking-widest">Sincronizando Nuvem...</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden">
        
        <header class="h-20 flex items-center justify-between px-10 border-b border-slate-800 shrink-0 bg-[#0b1120]/50 backdrop-blur-md">
            <div class="flex items-center gap-12">
                <div class="flex flex-col">
                    <span class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">Base Global</span>
                    <div class="flex items-baseline gap-2">
                        <span id="statTotal" class="text-2xl font-black text-white leading-none">0</span>
                        <span class="text-[9px] text-slate-600 font-bold uppercase">Propostas</span>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">M√©dia Setor</span>
                    <span id="statAvg" class="text-2xl font-black text-emerald-500 leading-none">0%</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="clearCloudData()" class="text-[9px] text-slate-500 hover:text-red-500 font-bold uppercase tracking-widest transition-all p-2">Limpar Banco Cloud</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-10 bg-[#0f172a] sidebar-scroll">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                <div onclick="openHO()" class="glass p-8 rounded-[2.5rem] border-l-4 border-l-blue-500 cursor-pointer hover:scale-[1.03] active:scale-95 transition-all group">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-[2px] group-hover:text-blue-400 transition-all">Eleg√≠veis Home Office</p>
                    <h2 id="statHO" class="text-6xl font-black text-white">0</h2>
                    <p class="text-[10px] mt-3 text-blue-500 font-black uppercase tracking-widest flex items-center gap-2">Ver Lista Completa <span class="text-lg">‚Üí</span></p>
                </div>
                
                <div class="glass p-8 rounded-[2.5rem] border-l-4 border-l-red-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-[2px]">Erros Cr√≠ticos</p>
                    <h2 id="statErrors" class="text-6xl font-black text-white">0</h2>
                    <p class="text-[10px] mt-3 text-slate-500 font-bold uppercase tracking-widest italic">Aten√ß√£o em Severidades</p>
                </div>

                <div class="glass p-8 rounded-[2.5rem] border-l-4 border-l-indigo-500 flex flex-col justify-between">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-[2px]">Filtrar Per√≠odo</p>
                        <input type="date" id="filterDate" onchange="applyFilters()" class="bg-slate-800/50 border border-slate-700 rounded-xl text-sm p-3 focus:ring-2 focus:ring-blue-500 outline-none w-full text-white mt-1 font-bold">
                    </div>
                </div>
            </div>

            <div id="detailsPlaceholder" class="h-80 flex flex-col items-center justify-center text-slate-600 italic border-2 border-dashed border-slate-800 rounded-[3rem] bg-slate-900/20">
                <p class="text-sm">Aguardando sele√ß√£o de analista para carregar BI...</p>
            </div>

            <div id="analystDetails" class="hidden">
                <div class="flex justify-between items-end mb-10">
                    <div>
                        <h2 id="detName" class="text-5xl font-black text-white mb-2 tracking-tighter"></h2>
                        <p id="detRankInfo" class="text-blue-500 font-black text-xs uppercase tracking-[3px]"></p>
                    </div>
                    <select id="filterSeverity" onchange="applyFilters()" class="bg-slate-800 border-none text-[10px] rounded-xl p-4 focus:ring-2 focus:ring-blue-500 outline-none font-black uppercase text-slate-300 tracking-widest">
                        <option value="TODOS">Exibir Apenas Erros</option>
                        <option value="TODOS_FULL">Exibir Tudo (Com Confere)</option>
                        <option value="GRAVISSIMO">Grav√≠ssimo</option>
                        <option value="GRAVE">Grave</option>
                        <option value="MEDIO">M√©dio</option>
                        <option value="LEVE">Leve</option>
                        <option value="NAO">Somente Confere</option>
                    </select>
                </div>

                <div id="logContainer" class="grid grid-cols-1 gap-4 pb-20"></div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = "https://qualidade-documental.vitor-hmartins007.workers.dev"; 

        let globalData = [];
        let currentAnalystName = null;
        let currentSort = 'prod';

        window.onload = loadCloudData;

        async function loadCloudData() {
            try {
                const res = await fetch(`${API_URL}/get-data`);
                globalData = await res.json();
                processData();
            } catch (err) {
                document.getElementById('analystList').innerHTML = '<p class="text-red-500 text-center text-[10px] font-bold p-10">FALHA NA SINCRONIZA√á√ÉO</p>';
            }
        }

        async function clearCloudData() {
            if(confirm("Deseja deletar permanentemente todos os registros da nuvem?")) {
                await fetch(`${API_URL}/clear`, { method: "DELETE" });
                location.reload();
            }
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = async (evt) => {
                const workbook = XLSX.read(evt.target.result, { type: 'binary' });
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                const formatted = rows.map(r => {
                    let clean = {};
                    Object.keys(r).forEach(k => clean[k.trim()] = r[k]);

                    const status = String(clean['Status Atendimento'] || "").trim().toUpperCase();
                    let sev = String(clean['SEVERIDADE'] || "NAO").trim().toUpperCase();
                    const manifesto = String(clean['Manifesto'] || "").toLowerCase();

                    if ((status.includes("N√ÉO CONFERE") || status.includes("NAO CONFERE")) && (sev === "NAO" || sev === "")) {
                        if (manifesto.includes("fraude") || manifesto.includes("autenticidade") || manifesto.includes("falsific")) sev = "GRAVISSIMO";
                        else if (manifesto.includes("c√°lculo") || manifesto.includes("180 dias") || manifesto.includes("vencid")) sev = "GRAVE";
                        else if (manifesto.includes("fac") || manifesto.includes("digitacao") || manifesto.includes("preenchimento")) sev = "LEVE";
                        else sev = "MEDIO";
                    }

                    return {
                        data: clean['Data'],
                        nome: clean['Operador 2'],
                        adesao: clean['Ades√£o'],
                        status: status.includes("N√ÉO CONFERE") || status.includes("NAO CONFERE") ? "N√ÉO CONFERE" : "CONFERE",
                        manifesto: clean['Manifesto'] || (status === "CONFERE" ? "An√°lise correta." : "-"),
                        severidade: sev,
                        produto: clean['Produto'] || clean['Grupo'] || 'CNC'
                    };
                }).filter(f => f.nome);

                await fetch(`${API_URL}/save-data`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formatted)
                });
                
                alert("Nuvem atualizada com sucesso!");
                loadCloudData();
            };
            reader.readAsBinaryString(file);
        });

        function processData() {
            const analysts = {};
            globalData.forEach(d => {
                if (!analysts[d.analista_nome]) analysts[d.analista_nome] = { name: d.analista_nome, total: 0, ok: 0, log: [] };
                analysts[d.analista_nome].total++;
                if (d.status === "CONFERE") analysts[d.analista_nome].ok++;
                analysts[d.analista_nome].log.push(d);
            });
            renderList(Object.values(analysts));
        }

        function changeSort(type) {
            currentSort = type;
            document.getElementById('btnSortProd').className = type === 'prod' ? 'flex-1 text-[9px] py-2 rounded-lg font-bold bg-slate-700 text-white uppercase' : 'flex-1 text-[9px] py-2 rounded-lg font-bold text-slate-500 uppercase hover:text-white';
            document.getElementById('btnSortQuali').className = type === 'quali' ? 'flex-1 text-[9px] py-2 rounded-lg font-bold bg-slate-700 text-white uppercase' : 'flex-1 text-[9px] py-2 rounded-lg font-bold text-slate-500 uppercase hover:text-white';
            processData();
        }

        function renderList(analysts) {
            const list = document.getElementById('analystList');
            list.innerHTML = '';

            const prodSorted = [...analysts].sort((a,b) => b.total - a.total);
            const displayList = currentSort === 'prod' ? prodSorted : [...analysts].sort((a,b) => (b.ok/b.total) - (a.ok/a.total));

            let hoCount = 0;
            displayList.forEach((a) => {
                const perc = (a.ok / a.total) * 100;
                const rankProd = prodSorted.indexOf(a) + 1;
                const isHO = perc >= 90 && rankProd <= 20;
                if(isHO) hoCount++;

                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl cursor-pointer border transition-all ${currentAnalystName === a.name ? 'bg-blue-600 border-blue-400 shadow-xl' : 'bg-slate-900/40 border-slate-800 hover:border-slate-600'}`;
                div.onclick = () => selectAnalyst(a.name);
                div.innerHTML = `
                    <div class="flex justify-between items-center text-white mb-2">
                        <span class="text-[11px] font-bold truncate pr-4">${a.name}</span>
                        <span class="text-[11px] font-black ${perc >= 90 ? 'text-emerald-400' : 'text-red-400'} ${currentAnalystName === a.name ? '!text-white' : ''}">${perc.toFixed(0)}%</span>
                    </div>
                    <div class="flex justify-between text-[8px] font-black uppercase tracking-widest ${currentAnalystName === a.name ? 'text-blue-100' : 'text-slate-500'}">
                        <span>Rank: ${rankProd}¬∫</span>
                        <span>Produ√ß√£o: ${a.total}</span>
                        ${isHO ? '<span class="text-blue-400">üè† HO</span>' : ''}
                    </div>
                `;
                list.appendChild(div);
            });

            document.getElementById('statTotal').innerText = globalData.length;
            document.getElementById('statAvg').innerText = analysts.length ? (analysts.reduce((acc, a) => acc + (a.ok/a.total), 0) / analysts.length * 100).toFixed(1) + '%' : '0%';
            document.getElementById('statHO').innerText = hoCount;
            document.getElementById('statErrors').innerText = globalData.filter(d => d.severidade === 'GRAVE' || d.severidade === 'GRAVISSIMO').length;
        }

        function selectAnalyst(name) {
            currentAnalystName = name;
            document.getElementById('detailsPlaceholder').classList.add('hidden');
            document.getElementById('analystDetails').classList.remove('hidden');
            applyFilters();
            processData();
        }

        function applyFilters() {
            if (!currentAnalystName) return;
            const analystData = globalData.filter(d => d.analista_nome === currentAnalystName);
            const sevFilter = document.getElementById('filterSeverity').value;
            const dateFilter = document.getElementById('filterDate').value;

            document.getElementById('detName').innerText = currentAnalystName;
            
            const prodSorted = [...processedAnalysts].sort((a,b) => b.total - a.total);
            const anaObj = processedAnalysts.find(a => a.name === currentAnalystName);
            const rank = prodSorted.indexOf(anaObj) + 1;
            const perc = (anaObj.ok / anaObj.total * 100).toFixed(1);
            
            document.getElementById('detRankInfo').innerText = `Produ√ß√£o: ${anaObj.total} Analises | Posi√ß√£o: ${rank}¬∫ | Qualidade: ${perc}%`;

            let logs = analystData;
            if (dateFilter) logs = logs.filter(l => l.data_analise && l.data_analise.includes(dateFilter));
            
            if (sevFilter === 'TODOS') {
                logs = logs.filter(l => l.status === "N√ÉO CONFERE");
            } else if (sevFilter === 'TODOS_FULL') {
                // N√£o filtra nada
            } else {
                logs = logs.filter(l => l.severidade === sevFilter);
            }

            const container = document.getElementById('logContainer');
            container.innerHTML = logs.length ? '' : '<p class="text-center text-slate-700 py-20 font-bold italic uppercase tracking-widest text-xs">Nenhum registro para este filtro</p>';

            logs.forEach(l => {
                const isErr = l.status === "N√ÉO CONFERE";
                const color = isErr ? (l.severidade === 'GRAVE' || l.severidade === 'GRAVISSIMO' ? 'red' : (l.severidade === 'MEDIO' ? 'orange' : 'amber')) : 'emerald';
                
                const div = document.createElement('div');
                div.className = `glass p-6 rounded-[2rem] border-l-4 border-l-${color}-500 transition-all hover:bg-slate-800/40`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex gap-2">
                            <span class="text-[9px] font-black uppercase text-${color}-400 bg-${color}-500/10 px-3 py-1 rounded-full border border-${color}-500/20">${l.severidade}</span>
                            <span class="text-[9px] font-black uppercase text-slate-500 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">Ades√£o: ${l.adesao}</span>
                        </div>
                        <span class="text-[9px] text-slate-600 font-black uppercase tracking-widest">${l.data_analise}</span>
                    </div>
                    <p class="text-sm text-slate-300 font-semibold mb-3 leading-relaxed">${l.manifesto}</p>
                    <div class="flex justify-between items-center pt-3 border-t border-slate-800/50">
                        <span class="text-[9px] text-blue-500 font-black uppercase tracking-[2px]">${l.produto}</span>
                        <span class="text-[9px] text-slate-700 font-black uppercase">${isErr ? 'Falha Detectada' : 'Aprovado'}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Vari√°vel auxiliar para acesso global nas fun√ß√µes de filtro
        let processedAnalysts = [];
        const originalProcessData = processData;
        processData = function() {
            const analysts = {};
            globalData.forEach(d => {
                if (!analysts[d.analista_nome]) analysts[d.analista_nome] = { name: d.analista_nome, total: 0, ok: 0, log: [] };
                analysts[d.analista_nome].total++;
                if (d.status === "CONFERE") analysts[d.analista_nome].ok++;
                analysts[d.analista_nome].log.push(d);
            });
            processedAnalysts = Object.values(analysts);
            renderList(processedAnalysts);
        };

        function openHO() {
            const prodSorted = [...processedAnalysts].sort((a,b) => b.total - a.total);
            const eligible = prodSorted.filter((a, i) => (a.ok/a.total) >= 0.9 && (i+1) <= 20);
            
            const list = document.getElementById('listHO');
            list.innerHTML = eligible.length ? '' : '<p class="text-center text-slate-600 py-10 font-bold uppercase text-[10px]">Nenhum analista eleg√≠vel</p>';
            eligible.forEach(a => {
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-slate-900/60 p-5 rounded-[1.5rem] border border-blue-500/10 transition-all hover:border-blue-500/40">
                        <span class="font-bold text-sm text-white truncate pr-4">${a.name}</span>
                        <span class="text-xs font-black text-emerald-400 bg-emerald-500/10 px-3 py-1 rounded-lg">${((a.ok/a.total)*100).toFixed(1)}%</span>
                    </div>
                `;
            });
            document.getElementById('modalHO').classList.remove('hidden');
        }

        function closeHO() { document.getElementById('modalHO').classList.add('hidden'); }
    </script>
</body>
</html>