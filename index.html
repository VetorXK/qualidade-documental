<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Documental Intelligence | Shared Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0b1120; color: #f1f5f9; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div class="flex h-screen">
        <aside class="w-80 border-r border-slate-800 p-6 flex flex-col">
            <h1 class="text-xl font-bold text-blue-400 mb-8 tracking-tighter italic">Análise Documental</h1>
            
            <label class="bg-blue-600 hover:bg-blue-500 p-3 rounded-xl text-center cursor-pointer font-bold text-sm transition-all mb-4">
                ☁️ SUBIR PARA NUVEM
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .csv">
            </label>

            <div id="analystList" class="flex-1 overflow-y-auto space-y-2 pr-2">
                <p class="text-slate-500 text-xs animate-pulse">Carregando dados da nuvem...</p>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto p-10">
            <header class="flex justify-between items-center mb-10">
                <div>
                    <h2 class="text-xs font-black text-slate-500 uppercase tracking-widest">Dashboard Compartilhado</h2>
                    <p class="text-sm text-slate-400">Todos os gestores visualizam estes dados</p>
                </div>
                <button onclick="clearCloudData()" class="text-xs text-red-400 hover:underline uppercase font-bold">ZERAR toda base de dados</button>
            </header>

            <div id="stats" class="grid grid-cols-3 gap-6 mb-10">
                <div class="glass p-6 rounded-3xl">
                    <p class="text-[10px] font-bold text-slate-500 uppercase">Total na Nuvem</p>
                    <h3 id="statTotal" class="text-4xl font-black">0</h3>
                </div>
                <div class="glass p-6 rounded-3xl" onclick="openHO()" style="cursor:pointer">
                    <p class="text-[10px] font-bold text-slate-500 uppercase">Elegíveis HO (Geral)</p>
                    <h3 id="statHO" class="text-4xl font-black text-blue-400">0</h3>
                </div>
                <div class="glass p-6 rounded-3xl border-l-4 border-indigo-500">
                    <input type="date" id="filterDate" onchange="renderDetails()" class="bg-transparent text-white w-full outline-none text-xl font-bold">
                </div>
            </div>

            <div id="details" class="hidden">
                <h2 id="detName" class="text-3xl font-black mb-6"></h2>
                <div id="logContainer" class="space-y-3"></div>
            </div>
        </main>
    </div>

    <script>
        // SUBSTITUA PELO LINK DO SEU WORKER APÓS O DEPLOY
        const API_URL = "https://qualidade-documental-worker.vitor-hmartins007.workers.dev"; 

        let globalData = [];
        let selectedAnalyst = null;

        async function loadCloudData() {
            const res = await fetch(`${API_URL}/get-data`);
            globalData = await res.json();
            processAndRender();
        }

        async function saveToCloud(data) {
            await fetch(`${API_URL}/save-data`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            loadCloudData();
        }

        async function clearCloudData() {
            if(confirm("Isso apagará os dados para TODOS os usuários. Confirmar?")) {
                await fetch(`${API_URL}/clear`, { method: "DELETE" });
                location.reload();
            }
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
    const reader = new FileReader();
    reader.onload = async (evt) => {
        try {
            const workbook = XLSX.read(evt.target.result, { type: 'binary' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rawRows = XLSX.utils.sheet_to_json(sheet);

            const formatted = rawRows.map(r => {
                // Limpa nomes de colunas (tira espaços extras)
                let cleanRow = {};
                Object.keys(r).forEach(key => {
                    cleanRow[key.trim()] = r[key];
                });

                return {
                    data: cleanRow['Data'],
                    nome: cleanRow['Operador 2'],
                    adesao: cleanRow['Adesão'],
                    status: cleanRow['Status Atendimento'],
                    manifesto: cleanRow['Manifesto'] || '-',
                    severidade: cleanRow['SEVERIDADE'] || 'NAO',
                    produto: cleanRow['Produto'] || cleanRow['Grupo'] || 'CNC'
                };
            });

            // Filtra linhas vazias onde o analista não existe
            const finalData = formatted.filter(f => f.nome);

            if (finalData.length === 0) {
                alert("Nenhum dado encontrado. Verifique se as colunas 'Operador 2' e 'Status Atendimento' existem na planilha.");
                return;
            }

            await saveToCloud(finalData);
            alert(`Sucesso! ${finalData.length} registros enviados para o banco Cloud.`);
        } catch (err) {
            console.error(err);
            alert("Erro ao processar arquivo: " + err.message);
        }
    };
    reader.readAsBinaryString(e.target.files[0]);
});

        function processAndRender() {
            const list = document.getElementById('analystList');
            list.innerHTML = '';
            
            const analysts = {};
            globalData.forEach(d => {
                if(!analysts[d.analista_nome]) analysts[d.analista_nome] = { name: d.analista_nome, total: 0, ok: 0 };
                analysts[d.analista_nome].total++;
                if(d.status.includes("CONFERE") && !d.status.includes("NÃO")) analysts[d.analista_nome].ok++;
            });

            const sorted = Object.values(analysts).sort((a,b) => b.total - a.total);
            sorted.forEach(a => {
                const perc = (a.ok / a.total) * 100;
                list.innerHTML += `
                    <div onclick="showDetails('${a.name}')" class="p-4 glass rounded-2xl mb-2 cursor-pointer hover:border-blue-500 transition-all">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold">${a.name}</span>
                            <span class="text-xs font-black ${perc >= 90 ? 'text-emerald-400' : 'text-red-400'}">${perc.toFixed(0)}%</span>
                        </div>
                    </div>
                `;
            });

            document.getElementById('statTotal').innerText = globalData.length;
            // Cálculo do HO simplificado para o exemplo
            document.getElementById('statHO').innerText = sorted.filter((a, i) => (a.ok/a.total) >= 0.9 && (i+1) <= 20).length;
        }

        function showDetails(name) {
            selectedAnalyst = name;
            document.getElementById('details').classList.remove('hidden');
            document.getElementById('detName').innerText = name;
            renderDetails();
        }

        function renderDetails() {
            if(!selectedAnalyst) return;
            const container = document.getElementById('logContainer');
            container.innerHTML = '';
            const dateF = document.getElementById('filterDate').value;
            
            const logs = globalData.filter(d => 
                d.analista_nome === selectedAnalyst && 
                (!dateF || d.data_analise.includes(dateF)) &&
                (!d.status.includes("CONFERE") || d.status.includes("NÃO"))
            );

            logs.forEach(l => {
                container.innerHTML += `
                    <div class="p-4 glass border-l-4 border-red-500 rounded-r-2xl">
                        <p class="text-sm font-medium">${l.manifesto}</p>
                        <div class="flex gap-4 mt-2 text-[10px] font-bold text-slate-500 uppercase">
                            <span>Adesão: ${l.adesao}</span>
                            <span>Data: ${l.data_analise}</span>
                        </div>
                    </div>
                `;
            });
        }

        loadCloudData();
    </script>
</body>
</html>