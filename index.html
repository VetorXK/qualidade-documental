<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise Documental | BI Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0b1120; color: #f1f5f9; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .collapsed-sidebar { width: 80px !important; }
        .sidebar-text { display: block; opacity: 1; transition: opacity 0.2s; }
        .collapsed-sidebar .sidebar-text { display: none; opacity: 0; }
        .card-mini { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255,255,255,0.1); padding: 1.2rem; border-radius: 1.5rem; text-align: center; flex: 1; min-width: 130px; }
    </style>
</head>
<body class="antialiased h-screen overflow-hidden flex text-slate-200">

    <datalist id="analystSuggestions"></datalist>

    <div id="modalHO" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass w-full max-w-lg rounded-[2.5rem] p-8 border border-blue-500/30 shadow-2xl text-white">
            <div class="flex justify-between items-center mb-6 font-bold">
                <div>
                    <h3 id="modalTitle" class="text-2xl text-blue-400 tracking-tighter">Listagem</h3>
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">Gest√£o Vitor Martins</p>
                </div>
                <button onclick="closeHO()" class="bg-slate-800 hover:bg-slate-700 w-10 h-10 rounded-full flex items-center justify-center text-xl">&times;</button>
            </div>
            <div id="listHO" class="space-y-3 max-h-[60vh] overflow-y-auto sidebar-scroll pr-2"></div>
        </div>
    </div>

    <aside id="sidebar" class="sidebar-transition w-80 border-r border-slate-800 flex flex-col bg-[#0b1120] shrink-0 relative">
        <div class="p-6 flex flex-col h-full text-white">
            <button onclick="toggleSidebar()" class="absolute -right-3 top-10 bg-blue-600 rounded-full w-6 h-6 flex items-center justify-center z-50 shadow-lg text-white border border-blue-400/20">
                <span id="sideIcon" class="text-[10px]">‚óÄ</span>
            </button>

            <div class="flex items-center gap-3 mb-8 overflow-hidden shrink-0">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center font-bold text-xl shrink-0 shadow-lg leading-none text-white">D</div>
                <div class="sidebar-text">
                    <h1 class="font-bold text-lg leading-tight italic tracking-tighter whitespace-nowrap">An√°lise Documental</h1>
                    <p class="text-[10px] text-slate-500 uppercase tracking-[2px]">Gest√£o: Vitor Martins</p>
                </div>
            </div>

            <label class="flex items-center justify-center gap-2 w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl cursor-pointer transition-all mb-6 font-bold text-sm shadow-lg overflow-hidden shrink-0 active:scale-95">
                <span class="text-lg">üìÇ</span>
                <span class="sidebar-text uppercase tracking-tighter">Importar Planilha</span>
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv">
            </label>

            <div class="sidebar-text flex gap-2 mb-6 bg-slate-900/80 p-1.5 rounded-xl border border-slate-800 shrink-0">
                <button onclick="changeSort('prod')" id="btnSortProd" class="flex-1 text-[9px] py-2 rounded-lg font-bold transition-all bg-slate-700 text-white uppercase">Produ√ß√£o</button>
                <button onclick="changeSort('quali')" id="btnSortQuali" class="flex-1 text-[9px] py-2 rounded-lg font-bold transition-all text-slate-500 uppercase hover:text-white">Qualidade</button>
            </div>

            <div id="analystList" class="flex-1 overflow-y-auto sidebar-scroll space-y-2 pr-1">
                <p class="text-center mt-10 text-slate-700 text-[10px] uppercase font-bold animate-pulse">Carregando...</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden">
        <header class="h-20 flex items-center justify-between px-10 border-b border-slate-800 shrink-0 bg-[#0b1120]/50 backdrop-blur-md">
            <div class="flex items-center gap-12 text-white font-bold">
                <div class="flex flex-col text-center">
                    <span class="text-[10px] text-slate-500 uppercase tracking-widest mb-1">Base Global</span>
                    <span id="statTotal" class="text-2xl font-black">0</span>
                </div>
                <div class="flex flex-col text-center">
                    <span class="text-[10px] text-slate-500 uppercase tracking-widest mb-1">M√©dia Setor</span>
                    <span id="statAvg" class="text-2xl font-black text-emerald-500">0%</span>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="toggleConfigRegras()" class="text-[9px] bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg font-bold uppercase text-blue-400 border border-blue-500/20">‚öôÔ∏è INTELIG√äNCIA DE SEVERIDADE</button>
                <button onclick="clearCloudData()" class="text-[9px] text-slate-600 hover:text-red-500 font-bold uppercase p-2 transition-all">LIMPAR BASE</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 bg-[#0f172a] sidebar-scroll">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 text-white font-bold">
                <div onclick="openHOList('ho')" class="glass p-8 rounded-[2.5rem] border-l-4 border-l-emerald-500 cursor-pointer hover:scale-[1.02] transition-all">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Eleg√≠veis Home Office</p>
                    <h2 id="statHO" class="text-5xl font-black">0</h2>
                </div>
                <div class="glass p-8 rounded-[2.5rem] border-l-4 border-l-red-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Erros Cr√≠ticos</p>
                    <h2 id="statErrors" class="text-5xl font-black text-white">0</h2>
                </div>
                <div onclick="openHOList('alerta')" class="glass p-8 rounded-[2.5rem] border-l-4 border-l-amber-500 cursor-pointer hover:scale-[1.02] transition-all">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Ponto de Aten√ß√£o</p>
                    <h2 id="statAlerts" class="text-5xl font-black text-amber-500">0</h2>
                </div>
            </div>

            <div class="glass p-8 rounded-[2.5rem] mb-10 grid grid-cols-1 md:grid-cols-5 gap-6 items-end text-white text-left">
                <div class="md:col-span-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 block ml-2">Buscar Analista</label>
                    <input type="text" id="mainSearch" list="analystSuggestions" oninput="applyGlobalFilters()" placeholder="Selecione o nome..." class="bg-slate-800 border-none rounded-xl text-xs p-4 w-full outline-none focus:ring-2 focus:ring-blue-500 text-white">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 block ml-2">N¬∫ Ades√£o (Global)</label>
                    <input type="text" id="searchAdesao" oninput="applyGlobalFilters()" placeholder="Protocolo..." class="bg-slate-800 border-none rounded-xl text-xs p-4 w-full outline-none text-white font-bold tracking-widest">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 block ml-2">Data An√°lise</label>
                    <input type="date" id="filterDate" onchange="applyGlobalFilters()" class="bg-slate-800 border-none rounded-xl text-xs p-4 w-full outline-none text-white">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 block ml-2">Status</label>
                    <select id="filterStatus" onchange="applyGlobalFilters()" class="bg-slate-800 border-none rounded-xl text-[10px] p-4 w-full font-bold uppercase outline-none text-white cursor-pointer">
                        <option value="TODOS">Somente Erros</option>
                        <option value="TUDO">Exibir Tudo</option>
                        <option value="CONFERE">Somente Acertos</option>
                    </select>
                </div>
            </div>

            <div id="detailsPlaceholder" class="h-64 flex flex-col items-center justify-center text-slate-600 border-2 border-dashed border-slate-800 rounded-[3rem]">
                <p class="text-sm font-bold uppercase tracking-widest">Selecione no menu ou pesquise uma ades√£o acima</p>
            </div>

            <div id="analystDetails" class="hidden">
                <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-8 mb-10">
                    <div>
                        <h2 id="detName" class="text-5xl font-black text-white mb-2 tracking-tighter capitalize leading-none"></h2>
                        <p id="detRankInfo" class="text-blue-500 font-bold text-[10px] uppercase tracking-[3px]"></p>
                    </div>
                    
                    <div class="flex flex-wrap gap-4 w-full xl:w-auto">
                        <div class="card-mini border-l-4 border-indigo-500 shadow-xl">
                            <span class="text-[9px] text-slate-500 block font-black uppercase mb-1">Analisadas</span>
                            <span id="cardDetTotal" class="text-2xl font-black text-white">0</span>
                        </div>
                        <div class="card-mini border-l-4 border-blue-500 shadow-xl">
                            <span class="text-[9px] text-slate-500 block font-black uppercase mb-1">Qualidade</span>
                            <span id="cardDetPerc" class="text-2xl font-black text-white">0%</span>
                        </div>
                        <div class="card-mini border-l-4 border-emerald-500 shadow-xl">
                            <span class="text-[9px] text-slate-500 block font-black mb-1 font-bold">ACERTOS</span>
                            <span id="cardDetOk" class="text-2xl font-black text-emerald-400">0</span>
                        </div>
                        <div class="card-mini border-l-4 border-red-500 shadow-xl">
                            <span class="text-[9px] text-slate-500 block font-black mb-1 font-bold">ERROS</span>
                            <span id="cardDetErr" class="text-2xl font-black text-red-400">0</span>
                        </div>
                    </div>
                </div>
                <div id="logContainer" class="grid grid-cols-1 gap-4 pb-20"></div>
            </div>

            <div id="configRegras" class="glass p-8 rounded-[2.5rem] mt-10 hidden border-blue-500/40 border">
                <h3 class="text-xl font-bold text-white mb-6 uppercase tracking-tighter">Regras de Severidade Autom√°tica</h3>
                <div class="flex flex-wrap gap-4 mb-6">
                    <input type="text" id="novaPalavra" placeholder="Frase contida no manifesto..." class="bg-slate-800 border-none rounded-xl text-xs p-4 flex-1 outline-none text-white focus:ring-2 focus:ring-blue-500">
                    <select id="novoNivel" class="bg-slate-800 border-none rounded-xl text-xs p-4 w-40 font-bold uppercase text-white cursor-pointer">
                        <option value="LEVE">LEVE</option>
                        <option value="MEDIO">M√âDIO</option>
                        <option value="GRAVE">GRAVE</option>
                        <option value="GRAVISSIMO">GRAV√çSSIMO</option>
                    </select>
                    <button onclick="salvarRegra()" class="bg-blue-600 hover:bg-blue-500 px-6 py-4 rounded-xl font-bold text-xs uppercase text-white shadow-lg transition-all">SALVAR REGRA</button>
                </div>
                <div id="listaRegras" class="flex flex-wrap gap-3"></div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = "https://qualidade-documental-worker.vitor-hmartins007.workers.dev"; 
        let globalData = [];
        let processedAnalysts = [];
        let severidadeRegras = [];
        let currentAnalystName = null;
        let sidebarOpen = true;
        let currentSort = 'prod';

        window.onload = async () => { await loadCloudData(); await loadRegras(); };

        function fixExcelDate(serial) {
            if (!serial || isNaN(serial)) return serial;
            const excelDate = parseFloat(serial);
            const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
            const dia = String(date.getDate()).padStart(2, '0');
            const mes = String(date.getMonth() + 1).padStart(2, '0');
            const ano = date.getFullYear();
            const hora = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${ano} ${hora}:${min}`;
        }

        async function loadCloudData() {
            try {
                const res = await fetch(`${API_URL}/get-data`);
                globalData = await res.json();
                processData();
            } catch (err) { console.error(err); }
        }

        async function loadRegras() {
            try { const res = await fetch(`${API_URL}/get-regras`); severidadeRegras = await res.json(); renderRegrasConfig(); } catch(e) {}
        }

        function processData() {
            const analysts = {};
            const datalist = document.getElementById('analystSuggestions');
            datalist.innerHTML = '';
            globalData.forEach(d => {
                const name = d.analista_nome;
                if (!analysts[name]) {
                    analysts[name] = { name, total: 0, ok: 0, log: [] };
                    const opt = document.createElement('option'); opt.value = name; datalist.appendChild(opt);
                }
                analysts[name].total++; if (d.status === "CONFERE") analysts[name].ok++;
                analysts[name].log.push(d);
            });
            processedAnalysts = Object.values(analysts);
            renderList(processedAnalysts);
            updateDashboardStats();
        }

        function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            document.getElementById('sidebar').classList.toggle('collapsed-sidebar');
            document.getElementById('sideIcon').innerText = sidebarOpen ? '‚óÄ' : '‚ñ∂';
        }

        function renderList(list) {
            const container = document.getElementById('analystList'); container.innerHTML = '';
            const prodSorted = [...processedAnalysts].sort((a,b) => b.total - a.total);
            const qualSorted = [...processedAnalysts].sort((a,b) => (b.ok/b.total) - (a.ok/a.total));
            const displayList = currentSort === 'prod' ? prodSorted : qualSorted;

            displayList.forEach(a => {
                const perc = (a.ok / a.total) * 100;
                const isSelected = currentAnalystName === a.name;
                const rank = (currentSort === 'prod' ? prodSorted : qualSorted).indexOf(a) + 1;
                const isHO = perc >= 90 && (prodSorted.indexOf(a) + 1) <= 20;

                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl cursor-pointer border transition-all ${isSelected ? 'bg-blue-600 border-blue-400 shadow-lg' : 'bg-slate-900/40 border-slate-800 hover:border-slate-600'}`;
                div.onclick = () => selectAnalyst(a.name);
                div.innerHTML = `
                    <div class="flex justify-between items-center text-white mb-1 font-bold">
                        <span class="text-[11px] truncate pr-2">${sidebarOpen ? a.name : a.name.substring(0,1)}</span>
                        ${sidebarOpen && isHO ? '<span class="text-[8px] bg-blue-500/30 text-blue-300 px-1 rounded">HO</span>' : ''}
                    </div>
                    ${sidebarOpen ? `<div class="flex justify-between text-[9px] font-black uppercase tracking-tighter ${isSelected ? 'text-blue-100' : 'text-slate-500'}">
                        <span>Rank: ${rank}¬∫</span>
                        <span class="${perc >= 90 ? 'text-emerald-400' : 'text-red-400'} ${isSelected ? '!text-white' : ''}">${perc.toFixed(0)}%</span>
                        <span>Prod: ${a.total}</span>
                    </div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        function selectAnalyst(name) {
            currentAnalystName = name;
            document.getElementById('mainSearch').value = name;
            applyGlobalFilters();
            renderList(processedAnalysts);
        }

        function applyGlobalFilters() {
            const searchA = document.getElementById('searchAdesao').value;
            const searchN = document.getElementById('mainSearch').value;
            let analyst = null;

            if (searchA) {
                const entry = globalData.find(d => d.adesao == searchA);
                if (entry) {
                    analyst = processedAnalysts.find(a => a.name === entry.analista_nome);
                    document.getElementById('mainSearch').value = entry.analista_nome;
                }
            } else {
                analyst = processedAnalysts.find(a => a.name === searchN) || processedAnalysts.find(a => a.name === currentAnalystName);
            }

            if (!analyst) return;
            currentAnalystName = analyst.name;
            const rank = [...processedAnalysts].sort((a,b) => b.total - a.total).indexOf(analyst) + 1;
            const perc = (analyst.ok / analyst.total * 100).toFixed(1);

            document.getElementById('detName').innerText = analyst.name;
            document.getElementById('detRankInfo').innerText = `PRODU√á√ÉO MENSAL: ${analyst.total} ANALISES | RANKING: ${rank}¬∫ NO SETOR`;
            document.getElementById('cardDetPerc').innerText = perc + '%';
            document.getElementById('cardDetTotal').innerText = analyst.total;
            document.getElementById('cardDetOk').innerText = analyst.ok;
            document.getElementById('cardDetErr').innerText = analyst.total - analyst.ok;

            const dateF = document.getElementById('filterDate').value;
            const statusF = document.getElementById('filterStatus').value;
            const container = document.getElementById('logContainer'); container.innerHTML = '';
            let logs = analyst.log;
            if(searchA) logs = logs.filter(l => l.adesao.includes(searchA));
            if(dateF) logs = logs.filter(l => l.data_analise.includes(dateF));
            if(statusF === 'TODOS') logs = logs.filter(l => l.status !== "CONFERE");
            else if(statusF === 'CONFERE') logs = logs.filter(l => l.status === "CONFERE");

            logs.forEach(l => {
                const isErr = l.status !== "CONFERE";
                const color = isErr ? (l.severidade === 'GRAVISSIMO' || l.severidade === 'GRAVE' ? 'red' : 'orange') : 'emerald';
                container.innerHTML += `<div class="glass p-6 rounded-[2rem] border-l-4 border-l-${color}-500 mb-2 transition-all"><div class="flex justify-between items-center mb-2 text-[10px] font-bold uppercase"><span class="text-${color}-400 font-black">${l.severidade}</span><span class="text-slate-500 tracking-widest">${l.data_analise}</span></div><p class="text-sm font-semibold mb-2">${l.manifesto}</p><span class="text-[9px] text-slate-600 font-bold uppercase tracking-widest">Ades√£o: ${l.adesao}</span></div>`;
            });

            document.getElementById('detailsPlaceholder').classList.add('hidden');
            document.getElementById('analystDetails').classList.remove('hidden');
        }

        function toggleConfigRegras() {
            const painel = document.getElementById('configRegras');
            painel.classList.toggle('hidden');
        }

        async function salvarRegra() {
            const termo = document.getElementById('novaPalavra').value; const nivel = document.getElementById('novoNivel').value;
            if(!termo) return;
            await fetch(`${API_URL}/save-regra`, { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({termo: termo.toLowerCase(), nivel}) });
            document.getElementById('novaPalavra').value = ''; await loadRegras();
        }

        function renderRegrasConfig() {
            const container = document.getElementById('listaRegras'); container.innerHTML = '';
            severidadeRegras.forEach(r => {
                const color = r.nivel === 'GRAVISSIMO' ? 'red' : (r.nivel === 'GRAVE' ? 'orange' : 'blue');
                container.innerHTML += `<div class="bg-slate-800 border border-slate-700 p-2 px-4 rounded-xl flex items-center gap-3 text-[10px] font-bold text-white shadow-sm"><span class="text-${color}-400 font-black">${r.nivel}:</span><span>${r.termo.toUpperCase()}</span></div>`;
            });
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async (evt) => {
                const workbook = XLSX.read(evt.target.result, { type: 'binary' });
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const formatted = rows.map(r => {
                    let clean = {}; Object.keys(r).forEach(k => clean[k.trim()] = r[k]);
                    const status = String(clean['Status Atendimento'] || "").trim().toUpperCase();
                    const manifesto = String(clean['Manifesto'] || "").toLowerCase();
                    let sev = "NAO";
                    if(status.includes("N√ÉO")) {
                        sev = "MEDIO"; 
                        severidadeRegras.forEach(regra => { if(manifesto.includes(regra.termo)) sev = regra.nivel; });
                    }
                    return {
                        data: fixExcelDate(clean['Data']),
                        nome: clean['Operador 2'],
                        adesao: clean['Ades√£o'],
                        status: status.includes("N√ÉO") ? "N√ÉO CONFERE" : "CONFERE",
                        manifesto: clean['Manifesto'] || "-",
                        severidade: sev,
                        produto: clean['Produto'] || 'CNC'
                    };
                }).filter(f => f.nome);
                await fetch(`${API_URL}/save-data`, { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(formatted) });
                alert("Importado com sucesso!"); loadCloudData();
            };
            reader.readAsBinaryString(file);
        });

        function changeSort(t) { currentSort = t; renderList(processedAnalysts); }
        async function clearCloudData() { if(confirm("Aten√ß√£o: Deseja apagar todos os dados da base?")) { await fetch(`${API_URL}/clear`, {method: "DELETE"}); location.reload(); } }
        function openHOList(type) {
            const prodSorted = [...processedAnalysts].sort((a,b) => b.total - a.total);
            let eligible = type === 'ho' ? prodSorted.filter((a, i) => (a.ok/a.total) >= 0.9 && (i+1) <= 20) : processedAnalysts.filter(a => (a.ok/a.total) >= 0.85 && (a.ok/a.total) < 0.90);
            const list = document.getElementById('listHO'); list.innerHTML = '';
            eligible.forEach(a => { list.innerHTML += `<div class="flex justify-between items-center bg-slate-800/50 p-5 rounded-3xl mb-2 border border-white/5 shadow-sm transition-all hover:bg-slate-800"><span class="font-bold text-sm text-white">${a.name}</span><span class="text-xs font-black text-white bg-blue-500/20 px-3 py-1 rounded-lg">${((a.ok/a.total)*100).toFixed(1)}%</span></div>`; });
            document.getElementById('modalHO').classList.remove('hidden');
        }
        function closeHO() { document.getElementById('modalHO').classList.add('hidden'); }
        function updateDashboardStats() {
            const prodSorted = [...processedAnalysts].sort((a,b) => b.total - a.total);
            document.getElementById('statTotal').innerText = globalData.length;
            document.getElementById('statAvg').innerText = processedAnalysts.length ? (processedAnalysts.reduce((acc, a) => acc + (a.ok/a.total), 0) / processedAnalysts.length * 100).toFixed(1) + '%' : '0%';
            document.getElementById('statHO').innerText = prodSorted.filter((a, i) => (a.ok/a.total) >= 0.9 && (i+1) <= 20).length;
            document.getElementById('statAlerts').innerText = processedAnalysts.filter(a => (a.ok/a.total) >= 0.85 && (a.ok/a.total) < 0.90).length;
            document.getElementById('statErrors').innerText = globalData.filter(d => d.severidade === 'GRAVE' || d.severidade === 'GRAVISSIMO').length;
        }
    </script>
</body>
</html>